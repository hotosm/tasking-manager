import os
import unittest
from server import create_app
from server.services.project_search_service import ProjectSearchService
from server.services.users.user_service import UserService
from server.models.postgis.project import ProjectInfo, Project
from shapely.geometry import Polygon
from unittest.mock import patch
from server.models.dtos.project_dto import ProjectSearchBBoxDTO
from server.models.postgis.user import User


class TestProjectSearchService(unittest.TestCase):
    skip_tests = False

    @classmethod
    def setUpClass(cls):
        env = os.getenv('SHIPPABLE', 'false')

        # Firewall rules mean we can't hit Postgres from Shippable so we have to skip them in the CI build
        if env == 'true':
            cls.skip_tests = True

    def setUp(self):
        if self.skip_tests:
            return

        self.app = create_app()
        self.ctx = self.app.app_context()
        self.ctx.push()

    def tearDown(self):
        if self.skip_tests:
            return

        self.ctx.pop()

    @patch.object(ProjectSearchService, '_make_4326_polygon_from_bbox')
    @patch.object(ProjectSearchService, 'validate_bbox_area')
    @patch.object(UserService, 'get_user_by_username')
    @patch.object(ProjectSearchService, '_get_intersecting_projects')
    @patch.object(ProjectInfo, 'get_dto_for_locale')
    def test_get_intersecting_projects(self, get_dto_for_locale, _get_intersecting_projects, get_user_by_username,
                                       validate_bbox_area, _make_4326_polygon_from_bbox):
        if self.skip_tests:
            return

        # arrange _make_4326_polygon_from_bbox mock
        _make_4326_polygon_from_bbox.return_value = Polygon(
            [(34.68826225820438, -12.59912449955007), (34.68826225820438, -11.57858317689196),
             (32.50198296132938, -11.57858317689196), (32.50198296132938, -12.59912449955007),
             (34.68826225820438, -12.59912449955007)])

        # arrange validate_bbox_area mock
        validate_bbox_area.return_value = True

        # arrange validate_bbox_area mock
        get_user_by_username.return_value = User(id=3488526)

        # arrange validate_bbox_area mock
        project = Project(id=2274,status=0,default_locale='en',geometry='{"type":"MultiPolygon","coordinates":[[[[34.0893707268651,-0.536513984601753],[34.0837097165999,-0.535368025180619],[34.0824012756666,-0.522611022751177],[34.0835189818563,-0.521118998858031],[34.0859489436038,-0.520412028506349],[34.0887794491696,-0.522691011775293],[34.0938186647061,-0.53062498601422],[34.0922393800162,-0.534533023725973],[34.0893707268651,-0.536513984601753]]],[[[34.0964317315364,-0.473861009201641],[34.0903701783458,-0.477777987607268],[34.0894088743771,-0.480300993106367],[34.0840606689686,-0.483107000623554],[34.0832290642053,-0.485565990460461],[34.0777206420479,-0.488045990479494],[34.0756301877947,-0.48638200784417],[34.0795097347646,-0.483161986306938],[34.0812988279751,-0.477977007985046],[34.0807914731244,-0.474739998452093],[34.0869102477411,-0.474655986304899],[34.0935516357163,-0.469579995295603],[34.0973091126488,-0.472213000194603],[34.0964317315364,-0.473861009201641]]],[[[33.9454116820645,-0.463559001916262],[33.9395599365248,-0.463423997083882],[33.9403190610894,-0.459735006029653],[33.945270538096,-0.461468995234408],[33.9454116820645,-0.463559001916262]]],[[[33.955379485646,-0.439756006467532],[33.9534111015895,-0.441495001379958],[33.9522895809163,-0.436744988255081],[33.9562606813082,-0.436861009014392],[33.955379485646,-0.439756006467532]]],[[[34.0426788324311,-0.441617995922242],[34.0579109193315,-0.454786986694148],[34.0618209834879,-0.466004014204983],[34.0680007929779,-0.475248992840064],[34.0617904656388,-0.483705997355769],[34.0581703181331,-0.486158997364131],[34.0514488214515,-0.48744401352108],[34.0425796502369,-0.492495000572894],[34.0173301691978,-0.49810600351348],[33.9986495967674,-0.499177009522071],[33.9948692319355,-0.495505989061121],[33.9925994866689,-0.489533991119976],[33.9869308467725,-0.485076010336786],[33.9746284482024,-0.482282013259886],[33.9698791503386,-0.478166014668594],[33.9621696468858,-0.480320007289396],[33.959869384821,-0.4795329870708],[33.9616203304768,-0.476166993823649],[33.9591789242271,-0.474866003235944],[33.9557609557607,-0.476051002849935],[33.9492187498746,-0.472840011421986],[33.9448890686212,-0.473563998816022],[33.9456787106334,-0.471403986181399],[33.9551696776208,-0.467249006781304],[33.9556808469152,-0.463665991905308],[33.9537200921702,-0.46022900949028],[33.9546508785988,-0.458112001448788],[33.9502983093133,-0.45217698870175],[33.9588890074224,-0.451597989312783],[33.9601211547147,-0.446150988264086],[33.9670181272535,-0.441754013979948],[33.9700202941679,-0.442532002917132],[33.9751205437283,-0.451126009810991],[33.9788589470794,-0.451622992748461],[33.9860610955408,-0.448074013291747],[33.993858337062,-0.441381007317147],[33.9966392511954,-0.441868007649385],[34.0144500725981,-0.436924994268909],[34.0217704769388,-0.426748991155693],[34.0259399414171,-0.424603999414845],[34.0310096737433,-0.425832003288011],[34.0374183653533,-0.436044991164478],[34.0426788324311,-0.441617995922242]]],[[[34.2754516596662,-0.401969999488986],[34.2715797423912,-0.401030987644172],[34.2744903559876,-0.400332987688116],[34.2754516596662,-0.401969999488986]]],[[[34.2781715389658,-0.381237000492777],[34.2761688228689,-0.382865995608465],[34.2743492121104,-0.381680995640269],[34.2783508301769,-0.379925996760625],[34.2781715389658,-0.381237000492777]]],[[[34.2143287655156,-0.395693004366286],[34.2142906182445,-0.405660004031797],[34.2120018004263,-0.411262006264649],[34.204349517321,-0.415695012092491],[34.2029495239652,-0.419582993174731],[34.1996002197026,-0.421483993822473],[34.1877708433517,-0.421559006677778],[34.1794395440855,-0.427493990015186],[34.1756782531266,-0.432850003983613],[34.165271758304,-0.438524991595183],[34.1613998410085,-0.444068014742153],[34.1456985469489,-0.429895997800304],[34.1378898619166,-0.428847998925689],[34.136909484728,-0.432891011472217],[34.134300231592,-0.433950991107749],[34.1333389278868,-0.437920988165511],[34.1311607357573,-0.438971996391205],[34.1283798215211,-0.437976003020405],[34.1264610287079,-0.433889001655333],[34.1176605223996,-0.427177011840722],[34.1166992184456,-0.422545999545391],[34.1192703248463,-0.411130011306752],[34.1313514703541,-0.415950000813917],[34.1384315486929,-0.412773013288862],[34.1467704774138,-0.40178999330445],[34.1569900507969,-0.399167001650706],[34.1601295471043,-0.394279987164107],[34.160659789502,-0.3878209894747],[34.1580696104563,-0.384274989420933],[34.1581687924587,-0.37681299451016],[34.1667213436273,-0.378331006020431],[34.1715507505398,-0.380257010370037],[34.1740303033703,-0.384128988337088],[34.1842308041676,-0.388287991819939],[34.1941604611658,-0.39040300288116],[34.1969604491079,-0.398047000614702],[34.1994781489183,-0.400009989819131],[34.2037086481541,-0.397612005717622],[34.2089195247285,-0.390827000545428],[34.2076797480607,-0.387234986055222],[34.2105598449187,-0.376715004601617],[34.2103385922229,-0.36443001056801],[34.2191810601522,-0.36015901038489],[34.2211189268839,-0.354171991759936],[34.2236709588762,-0.356640011645463],[34.2278518671235,-0.357789009821622],[34.2276496881491,-0.359632999264451],[34.2177581787943,-0.380856007496425],[34.2143287655156,-0.395693004366286]]],[[[34.2518005369727,-0.355477988879186],[34.2492980956664,-0.356083989530268],[34.2500114441154,-0.352638006396314],[34.2546806336564,-0.351561993650388],[34.2518005369727,-0.355477988879186]]],[[[34.2636184686575,-0.346350014132461],[34.2605094907419,-0.351669013877824],[34.2555198663605,-0.3504230086018],[34.2567787165965,-0.34663200411094],[34.2636184686575,-0.346350014132461]]],[[[34.7582206719739,-0.31252101087114],[34.7583808897327,-0.31669801508201],[34.7630691524777,-0.315403998108347],[34.7676086423743,-0.314383000305777],[34.7735099793049,-0.320845991625677],[34.7772483822775,-0.320601999839968],[34.7792587277671,-0.322156995636362],[34.7803993223333,-0.325801014855357],[34.7830009457264,-0.324263006498863],[34.7873992919402,-0.332888990771244],[34.7825813293905,-0.334661990704691],[34.7857704159269,-0.346581995440046],[34.7891006467147,-0.345259994365036],[34.7910690307328,-0.345991999112342],[34.7900810241752,-0.348499000422978],[34.7909393311158,-0.350154012735152],[34.7962989806356,-0.351779014158352],[34.7963409423905,-0.353913993008774],[34.799270629772,-0.35537099866552],[34.8058509826727,-0.356851994946864],[34.8103294373075,-0.35494199412092],[34.811920165839,-0.361380994683084],[34.8153495787066,-0.367538988586328],[34.822010040142,-0.375279009500654],[34.8231887818121,-0.388823986316104],[34.8349685665297,-0.390866011737571],[34.8395805358943,-0.39437299970995],[34.8547096251044,-0.393049001816052],[34.8581581113839,-0.393871993094201],[34.8591995235789,-0.396349012801326],[34.8614196776106,-0.397379994409412],[34.864028930384,-0.397596001585913],[34.8667411800724,-0.39584100258521],[34.8800506592569,-0.398986011932382],[34.882549285679,-0.39778301152296],[34.8892898558066,-0.404336005388276],[34.8909606930819,-0.403268993253184],[34.8915901180646,-0.399742990849798],[34.8960609436001,-0.398467004451745],[34.9023208614997,-0.393781006539643],[34.9141883848943,-0.389872014812091],[34.9129295347827,-0.397105991776296],[34.9135284423775,-0.406210988992565],[34.9157791136356,-0.408109992857834],[34.9262809752293,-0.406415999172597],[34.9296684262365,-0.415033996126971],[34.9339103697409,-0.415926993119768],[34.9367218016871,-0.414869993979198],[34.9400482174569,-0.417192012124249],[34.9476394649912,-0.418792009368722],[34.9588203430649,-0.419268012259248],[34.964580535695,-0.414997011740574],[34.9682312010619,-0.416606009222934],[34.9742088316808,-0.414806008342675],[34.9797897336172,-0.416812002955495],[34.9864196774759,-0.416004985686217],[34.9888610840591,-0.41196200288656],[35.0020790099141,-0.408315003142937],[35.0098304748598,-0.393557995512931],[35.0165290828926,-0.400588989310594],[35.020030975015,-0.407977998203072],[35.0201301573808,-0.413237988913887],[35.0087089539056,-0.422464013032612],[34.984081268035,-0.435945004299202],[34.9849891660104,-0.438230991460368],[34.9612197872309,-0.448563993126587],[34.9566688537146,-0.453774988592296],[34.9549102782375,-0.452564001210013],[34.9318504333034,-0.470339000564194],[34.913478851067,-0.478635013276366],[34.9130516050926,-0.481783002938289],[34.903900146467,-0.484786987561828],[34.9031181333965,-0.482174992638721],[34.8889503477,-0.486799001910646],[34.8890991210648,-0.488941997632412],[34.8768196104796,-0.494208991844917],[34.8734207150136,-0.492906988010304],[34.8568992612835,-0.506024003234788],[34.844890594425,-0.513670027293837],[34.8381004330379,-0.516238987710852],[34.8374481199198,-0.518221974371861],[34.8363800047042,-0.516646981491657],[34.8180885311651,-0.519816994747283],[34.8184700009565,-0.523418009515079],[34.8106613157707,-0.526766002395344],[34.8081092832507,-0.524913012938803],[34.791728973295,-0.533563017878239],[34.7921409604513,-0.536637008237299],[34.7841415404687,-0.54204797741411],[34.7818489074306,-0.539662003610068],[34.7724494933551,-0.543299019671276],[34.7598190305008,-0.551342010749138],[34.7590904232552,-0.554727018199034],[34.7576103208967,-0.552761972309827],[34.7526588440351,-0.557133019010684],[34.7405891414782,-0.55939000844221],[34.7276000973846,-0.556751013019578],[34.7248611448276,-0.55805397054927],[34.7239189148249,-0.562395990012802],[34.7205581663754,-0.563807010858834],[34.7084693905658,-0.56334197550079],[34.7025794979385,-0.57107502236711],[34.7027893065484,-0.574231028654441],[34.7006187437383,-0.578173995100854],[34.6939506531515,-0.585781991773064],[34.6956901546825,-0.588460028169261],[34.6820793151083,-0.605611026354928],[34.6772689817705,-0.607928991417576],[34.6687088010492,-0.608528018135938],[34.6579513547959,-0.608295023463937],[34.6559104916652,-0.606912016991926],[34.6537895201871,-0.609516978259065],[34.6391716004,-0.634738028207663],[34.6383705139055,-0.637398004544013],[34.6397781372785,-0.638979017954337],[34.6343193051887,-0.665705025246125],[34.6205406186134,-0.658393025710317],[34.6131210324846,-0.656325995932842],[34.5904312130281,-0.654632985651808],[34.581218719295,-0.654644012660536],[34.5782089233828,-0.661484003434846],[34.5757789609572,-0.663455009692252],[34.5589103696885,-0.668734014040843],[34.5568008421623,-0.676910996394468],[34.5484886165825,-0.689158976147545],[34.546669006078,-0.691166996901663],[34.5432510376571,-0.691955983595508],[34.5411796568859,-0.694706976771434],[34.5331611633244,-0.710030973139712],[34.5330390927199,-0.738547981046071],[34.5311889646065,-0.74408400068167],[34.5243301391048,-0.751465976566904],[34.523319244073,-0.755219996094406],[34.4829406738704,-0.790274977619968],[34.481559753165,-0.802295029175752],[34.4693298338285,-0.825273990933598],[34.4647102352386,-0.837071001531768],[34.4626693723591,-0.851777970927684],[34.463150024297,-0.86771601449314],[34.439430236495,-0.847472012212406],[34.4319496151321,-0.84376698732516],[34.427528381048,-0.838150978357247],[34.4123306274858,-0.830712020621397],[34.403789520136,-0.824156999657325],[34.3919181822002,-0.820127010642739],[34.3891296386327,-0.817822992967247],[34.385238647331,-0.822346985545578],[34.3878517148165,-0.828027010274183],[34.3914909362143,-0.830556988990309],[34.3912887569553,-0.832229972125801],[34.3883514403493,-0.835080981457174],[34.3813896176497,-0.847465992037647],[34.3720703123242,-0.849992990548269],[34.3659706116052,-0.855206012842816],[34.3547210691039,-0.853002011902929],[34.3498115536549,-0.850507974769047],[34.3469085691785,-0.850807011304048],[34.3483581542548,-0.857419014179398],[34.3378715512162,-0.857151985548191],[34.3353996275051,-0.861966013846852],[34.3323783872629,-0.864336014174842],[34.3219299313395,-0.866934001400902],[34.3207893371094,-0.869368016840148],[34.3120613097195,-0.862017989402179],[34.2967910765639,-0.841571986879134],[34.2831993100554,-0.829490006164039],[34.2800292969425,-0.827283978678287],[34.2706985473092,-0.826963007798812],[34.255760192745,-0.823557973140846],[34.2516403194844,-0.819657981545666],[34.2500114439606,-0.813898980606246],[34.2352981564387,-0.796841025397369],[34.2297096252092,-0.785510003755067],[34.2168884277723,-0.774847984475694],[34.2137908932448,-0.773727000078476],[34.2022590634571,-0.756389021871654],[34.1978187557433,-0.755196988621768],[34.1961212158267,-0.755307019070076],[34.1938896178212,-0.763637006417354],[34.1874885558975,-0.769863009458919],[34.1785888671669,-0.768164992467638],[34.1735115048629,-0.775547981240602],[34.1637001037083,-0.777657985893913],[34.146179199202,-0.78438401217971],[34.1350784301819,-0.790953993738234],[34.1248512266192,-0.794811010392652],[34.1202583310897,-0.787449002496724],[34.1031608581006,-0.787481009961492],[34.0980987548552,-0.789156019846152],[34.0904998777627,-0.793381989008938],[34.0821304321186,-0.805714011166162],[34.0756301878191,-0.807959020223218],[34.0731887813577,-0.805734992162836],[34.0713806149705,-0.799772024263116],[34.070911407347,-0.795912028064797],[34.0761718746124,-0.788185000296319],[34.0791702268929,-0.786366999075553],[34.0781211854283,-0.77315700064691],[34.0756797788177,-0.770870983553066],[34.0727310176464,-0.771928012775884],[34.0707702635395,-0.774968982057692],[34.0678100581323,-0.776280999365201],[34.0652008054693,-0.775638997715759],[34.0682983398867,-0.769587993507218],[34.0722885124991,-0.765767992213887],[34.0734596248886,-0.75789797296986],[34.0711402893946,-0.742384017023116],[34.0682716362661,-0.738946974186464],[34.0656585691013,-0.731875002658081],[34.0589599610651,-0.72876399809079],[34.0561790467475,-0.7291809921991],[34.0511894221542,-0.732782006194536],[34.0431709283489,-0.734619022046682],[34.0432586663373,-0.739524007362461],[34.0412483211126,-0.742564022830797],[34.0390701292639,-0.743134022115547],[34.0375518798052,-0.741271973341088],[34.0341415399172,-0.742411017949055],[34.0290107721199,-0.740079999563629],[34.0344581600094,-0.738240004025029],[34.0370407099569,-0.735108971714719],[34.0365409849073,-0.729981005287054],[34.0402297971026,-0.730431974673244],[34.0455207822751,-0.72615200287414],[34.0493698114945,-0.72751700888947],[34.0549507137005,-0.722702980450744],[34.057571411253,-0.717764974292993],[34.0569000236933,-0.714806020454154],[34.04867935143,-0.710771978655859],[34.0502204887992,-0.701833010373213],[34.0476188661232,-0.696263015386548],[34.0508689874669,-0.688364028892766],[34.0486183167265,-0.685244023969903],[34.0509605408343,-0.682855010357811],[34.0527191162991,-0.682901025140196],[34.05387115413,-0.67493999052484],[34.0474395745586,-0.666799008970179],[34.0528297425442,-0.653914988114916],[34.0501098632817,-0.649474978372914],[34.0444602961453,-0.650641978499759],[34.0443992613612,-0.648643016910792],[34.0485992431052,-0.645349979282076],[34.050479888771,-0.645856023060513],[34.0521888733874,-0.63608497387884],[34.0674095147023,-0.634290993351509],[34.0785484311953,-0.62570297740823],[34.088008880649,-0.611697971865403],[34.0916709895808,-0.610395014213498],[34.0937614438246,-0.605754018462416],[34.0918388365711,-0.600144982953824],[34.0879898064917,-0.596826971219836],[34.0745315544818,-0.597922981413904],[34.0739402768513,-0.595815003636328],[34.0774497980607,-0.5891940001894],[34.0760116570081,-0.586480021509032],[34.0684509274621,-0.583840012666918],[34.0651397701482,-0.576095999009033],[34.0606918334776,-0.572252988952719],[34.0639114377092,-0.567799985398557],[34.0726585385331,-0.56365597311954],[34.0796394349264,-0.56975299151503],[34.083549499657,-0.571188987051289],[34.0907783504521,-0.570609986860741],[34.1054115294824,-0.559733987424752],[34.107849120367,-0.552416026847594],[34.1064682007827,-0.547809005070191],[34.1071090695246,-0.543847978198801],[34.1143112175524,-0.536817014212047],[34.1167907714685,-0.539178014319734],[34.1197319029813,-0.550728977437468],[34.1235885614383,-0.552347004589108],[34.1289405823148,-0.551360011161143],[34.1317291253374,-0.552417993454294],[34.1394081113554,-0.548582017566871],[34.1423187250372,-0.544880986087096],[34.144321441609,-0.545468986685797],[34.1475105283877,-0.543361008615654],[34.152400970355,-0.543421984053153],[34.156341552752,-0.545683026385006],[34.1595382683595,-0.540082991103644],[34.1603202817098,-0.515251994711433],[34.1581497192617,-0.504496992292562],[34.1604881281574,-0.499439001384675],[34.1609497063407,-0.489695996220955],[34.163379669048,-0.483860999881784],[34.1732902527968,-0.470301002784427],[34.1869506834279,-0.460844010098408],[34.1926994320973,-0.454766006007449],[34.2032890318822,-0.4207769933714],[34.2061386102449,-0.424387008706865],[34.2087097168159,-0.431968003499942],[34.2182998652968,-0.438279002810108],[34.2254219053305,-0.436731010872808],[34.2365684502905,-0.441911995742642],[34.2524681086205,-0.436401009552138],[34.2529907221092,-0.44451698703856],[34.2594184869813,-0.446025997923519],[34.2629013060622,-0.452048987886204],[34.2688789366629,-0.45137000094824],[34.2703590387349,-0.455511004157731],[34.2741394036691,-0.458741009483158],[34.280330657895,-0.456106007033767],[34.2824592583154,-0.45748299434674],[34.2834892273559,-0.459463000604624],[34.2800407402638,-0.460276991155232],[34.2789001466036,-0.463705003632667],[34.283550261735,-0.469538987016963],[34.2834396362384,-0.473872006067547],[34.2976913450659,-0.475064009430141],[34.3135986329124,-0.480857998356647],[34.3105201715903,-0.474254995573612],[34.3003311153427,-0.467819005557572],[34.3049507136834,-0.463645995390642],[34.3085594172338,-0.463880002625653],[34.315311431233,-0.459791988851047],[34.317020415631,-0.451388002025403],[34.3193092341998,-0.450635999371566],[34.3215293879414,-0.453613012918267],[34.3230705258005,-0.463761985581871],[34.3267593379654,-0.468165010196024],[34.3342285152181,-0.471148014610527],[34.3357505794744,-0.473010987297488],[34.3354301451036,-0.4886249906958],[34.3418083185914,-0.493146986526297],[34.3470687859187,-0.500118971602229],[34.3529014582467,-0.493514001737942],[34.3521194456529,-0.483509987777601],[34.366508483601,-0.479157001339806],[34.3675308224165,-0.476034999154943],[34.3668594355767,-0.464170009646362],[34.3624382015901,-0.459681987671771],[34.3632583617092,-0.456544012204122],[34.3678703301685,-0.453404993492671],[34.3700981136261,-0.449063987204993],[34.3764991752945,-0.456070005798174],[34.3916893006763,-0.458047985911118],[34.401031494224,-0.456772000208509],[34.4029693602712,-0.467581987417169],[34.4088096617819,-0.469994991905746],[34.4044914238342,-0.472618013842378],[34.4040718075724,-0.475937009620412],[34.4056816096003,-0.479736000529644],[34.4168281556415,-0.486526012354353],[34.4182815549457,-0.498194993204119],[34.4238395691904,-0.497153014227329],[34.4309196471564,-0.492648006171129],[34.4334793087006,-0.493081003646959],[34.4351005552834,-0.49733999363866],[34.4360809325886,-0.50118499989729],[34.434089660598,-0.510565996614679],[34.424320220237,-0.509644985527284],[34.4156608576732,-0.522058010291885],[34.4154510495269,-0.533038020703262],[34.4202499384653,-0.538254976419576],[34.4232292167982,-0.537786007495437],[34.43722915608,-0.530489981734109],[34.4576988221713,-0.52347499174317],[34.4714088432659,-0.515331984031223],[34.4840393059932,-0.510987997642402],[34.486560821311,-0.508825003996875],[34.4892196652765,-0.502313018317028],[34.4898605347394,-0.496461004262265],[34.4885215756286,-0.494433999326097],[34.4913215631515,-0.492246002432743],[34.4953498838338,-0.493075997261786],[34.4951210022943,-0.491421014145014],[34.4967803952732,-0.490705997263222],[34.5017700192491,-0.491519004300737],[34.5097999569706,-0.474269002690856],[34.4976615900979,-0.461302995572214],[34.4897499083798,-0.457078993406483],[34.4789581294039,-0.445430994406663],[34.4715805049799,-0.441020995268441],[34.466499328408,-0.432491988560971],[34.4506492612813,-0.415082007832338],[34.4478988645194,-0.403017997841618],[34.4443511956121,-0.398584991931709],[34.4436111447052,-0.39542201172729],[34.4468612671222,-0.391503989593715],[34.4472808838166,-0.385053992888977],[34.4562110896362,-0.367188007367484],[34.4594993588715,-0.354263008206138],[34.4777793883361,-0.346300005779269],[34.4901199339982,-0.34630900690649],[34.4986915589147,-0.339442015196204],[34.5182800293198,-0.333279013679969],[34.5369796747646,-0.328709006646547],[34.5505218502734,-0.328009992847082],[34.5661201477624,-0.330810994514755],[34.5712890621413,-0.336508989801025],[34.5864715573582,-0.3466799859601],[34.5956306454186,-0.348459988858955],[34.6072006223563,-0.348713010832994],[34.6107215880723,-0.343385011144085],[34.6141014098723,-0.341919005308692],[34.6267089844781,-0.340615987849872],[34.6286888119123,-0.341156005802005],[34.6325187675872,-0.350391001042175],[34.6447486877118,-0.352214009250388],[34.6584892268869,-0.356934011228453],[34.6620483394615,-0.356644988285097],[34.6638908386978,-0.354889989433075],[34.6727981561785,-0.357482999764506],[34.6768302916616,-0.356974989931195],[34.6861915588006,-0.352155000077462],[34.6959991451256,-0.354178995010005],[34.6998481746875,-0.353742986990006],[34.7048492426555,-0.350946993123794],[34.7092781065951,-0.354761988308264],[34.7306289671357,-0.356649011863722],[34.7413291932561,-0.352975011359628],[34.7559013363737,-0.352964014576499],[34.7630996703498,-0.336782008282447],[34.763130187823,-0.327603996050633],[34.7587394710526,-0.322838008741381],[34.7507514951339,-0.320596009467681],[34.7471885678729,-0.312557012604734],[34.7473487852729,-0.308162987982089],[34.7454299924869,-0.304329008317231],[34.7516098015184,-0.300310999323709],[34.7524299622871,-0.293628990558029],[34.7575492852908,-0.300999999306465],[34.7566299433373,-0.308676005154477],[34.7582206719739,-0.31252101087114]]],[[[34.3994903560935,-0.254267991244887],[34.3970108032719,-0.253908008974494],[34.4013214111923,-0.251022995196485],[34.4017791743855,-0.252530992768988],[34.3994903560935,-0.254267991244887]]],[[[34.1367187496645,-0.24409900678151],[34.1348915094622,-0.246243000392158],[34.1344490048806,-0.241639003507447],[34.1362686151219,-0.241992995808608],[34.1367187496645,-0.24409900678151]]],[[[34.1424903865964,-0.226278006942752],[34.1440010069603,-0.227889001630092],[34.1479988097435,-0.227724999554172],[34.1474494933468,-0.233108998002222],[34.1487312313635,-0.235117003691857],[34.1431007386267,-0.241015002285198],[34.1433792107537,-0.245220005740591],[34.1419181823993,-0.245383993358565],[34.1405982970632,-0.243122995248227],[34.141139983766,-0.23482699730886],[34.1335601804736,-0.231389999441659],[34.1395797731,-0.230031997591843],[34.1402587885971,-0.227228999215948],[34.1424903865964,-0.226278006942752]]],[[[34.1140289307814,-0.214855000728845],[34.1142387386113,-0.221377998995979],[34.1170005791669,-0.224905997762796],[34.114749908376,-0.225765005461102],[34.1110191342269,-0.223196998939716],[34.1095314022483,-0.220057994860915],[34.1094894406354,-0.21593299523273],[34.1140289307814,-0.214855000728845]]],[[[34.4601287838158,-0.215441004048315],[34.4576797481487,-0.217079997201956],[34.4563102723182,-0.215496004321451],[34.4568099972457,-0.213398993618589],[34.4675712579274,-0.2100050007577],[34.4601287838158,-0.215441004048315]]],[[[34.518421173039,-0.206698000877984],[34.5200386045181,-0.20788300095285],[34.5236816405419,-0.206997007583868],[34.5239410394751,-0.208343998064179],[34.5185508722993,-0.213635995966025],[34.5161590576878,-0.214614004630746],[34.5155715941595,-0.211816997059059],[34.5119209287706,-0.2104970066698],[34.5082283014411,-0.216396004245904],[34.5004692075734,-0.213556006777153],[34.4984397885346,-0.218287006036259],[34.4964790342599,-0.217318997325647],[34.4956092831303,-0.212118000349885],[34.502929687432,-0.200975001600127],[34.509170532324,-0.196326002751571],[34.5174217224807,-0.194516003818882],[34.5191917419178,-0.196198002003704],[34.5162200921552,-0.202952996325382],[34.518421173039,-0.206698000877984]]],[[[34.0568504333938,-0.192895994180268],[34.055400848418,-0.193039000564602],[34.0549697873727,-0.191231996185407],[34.0574417114117,-0.189449995967354],[34.0568504333938,-0.192895994180268]]],[[[34.5378608703482,-0.183923006587942],[34.5444297783191,-0.186717003994445],[34.5436210627033,-0.18843500334416],[34.5395889277135,-0.189955994372752],[34.5374298094948,-0.188463002717202],[34.536289215183,-0.186029002680658],[34.5378608703482,-0.183923006587942]]],[[[34.5419311520741,-0.177554995459931],[34.5372085568702,-0.177201002756337],[34.5354614251704,-0.175465003046841],[34.5363998405701,-0.1735209974197],[34.5393600456777,-0.172552004755814],[34.5441207884934,-0.174659997249441],[34.5419311520741,-0.177554995459931]]],[[[34.5511016838423,-0.182683006154941],[34.5497207642557,-0.183956995819815],[34.5482292169827,-0.18155199332737],[34.5453987115703,-0.172923997004285],[34.5487403871132,-0.171819999859916],[34.5495491024781,-0.173067003763431],[34.5491409300549,-0.176477000202428],[34.5524291988164,-0.179000005227063],[34.5511016838423,-0.182683006154941]]],[[[34.6083106991855,-0.160131007388101],[34.6149406427355,-0.159730002525364],[34.608940123785,-0.166026994763317],[34.6068801877634,-0.165728003413682],[34.6035194389719,-0.169064999321015],[34.6028289792516,-0.16241699502844],[34.6003990167273,-0.160761997604623],[34.6007881163203,-0.158963993230258],[34.6083106991855,-0.160131007388101]]],[[[34.045108794793,-0.135089994200292],[34.043380737124,-0.136049002725151],[34.0413894648103,-0.133091002945988],[34.0467910759328,-0.131053999547496],[34.0495986939957,-0.132810995049119],[34.045108794793,-0.135089994200292]]],[[[34.0102806089366,-0.128078997777673],[34.0132789612483,-0.128405005153257],[34.0161590573009,-0.126378998698566],[34.0177001950656,-0.130412996241417],[34.0238304137994,-0.133670002439227],[34.0317001341465,-0.128378004044975],[34.0367202754878,-0.126586005443822],[34.0388107294861,-0.127607003204381],[34.0369911191701,-0.130215004542825],[34.0267601010053,-0.135308995968923],[34.0240211487638,-0.141975000926457],[34.0196914668423,-0.140771999875237],[34.0166702266165,-0.143105999013996],[34.0095405575111,-0.141286999235816],[34.00308990427,-0.136683002556363],[34.0004692078828,-0.137262002154141],[33.9991111751425,-0.139939993995134],[33.9956207269556,-0.134287998315211],[33.9916610713048,-0.133346006817162],[33.9866561887919,-0.136118993785121],[33.9867858880363,-0.127811998463105],[33.9913787837895,-0.126678004990381],[33.9958686828561,-0.121123001650573],[34.0060005185283,-0.124252997846045],[34.0102806089366,-0.128078997777673]]],[[[34.0999984741821,-0.135629996806123],[34.0973281854461,-0.13674199632561],[34.0929489136276,-0.134572998173591],[34.0923995964831,-0.129841000467649],[34.0875015256742,-0.126992002052066],[34.0911407468937,-0.124214001415072],[34.0930213922766,-0.120668001512562],[34.097450255924,-0.122630000202121],[34.1001281732362,-0.127587005499911],[34.0999984741821,-0.135629996806123]]]]}')
        projects = [project]
        _get_intersecting_projects.return_value = projects

        # arrange validate_bbox_area mock
        get_dto_for_locale.return_value = ProjectInfo(name='PEPFAR Kenya: Homa Bay')

        # arrange dto
        dto = ProjectSearchBBoxDTO()
        dto.bbox = map(float, '34.404,-1.034, 34.717,-0.624'.split(','))
        dto.preferred_locale = 'en'
        dto.input_srid = 4326
        dto.project_author = 'NateHeard'
        dto.validate()

        expected = '{"features": [{"geometry": {"coordinates": [[[[34.0893707268651, -0.536513984601753], [34.0837097165999, -0.535368025180619], [34.0824012756666, -0.522611022751177], [34.0835189818563, -0.521118998858031], [34.0859489436038, -0.520412028506349], [34.0887794491696, -0.522691011775293], [34.0938186647061, -0.53062498601422], [34.0922393800162, -0.534533023725973], [34.0893707268651, -0.536513984601753]]], [[[34.0964317315364, -0.473861009201641], [34.0903701783458, -0.477777987607268], [34.0894088743771, -0.480300993106367], [34.0840606689686, -0.483107000623554], [34.0832290642053, -0.485565990460461], [34.0777206420479, -0.488045990479494], [34.0756301877947, -0.48638200784417], [34.0795097347646, -0.483161986306938], [34.0812988279751, -0.477977007985046], [34.0807914731244, -0.474739998452093], [34.0869102477411, -0.474655986304899], [34.0935516357163, -0.469579995295603], [34.0973091126488, -0.472213000194603], [34.0964317315364, -0.473861009201641]]], [[[33.9454116820645, -0.463559001916262], [33.9395599365248, -0.463423997083882], [33.9403190610894, -0.459735006029653], [33.945270538096, -0.461468995234408], [33.9454116820645, -0.463559001916262]]], [[[33.955379485646, -0.439756006467532], [33.9534111015895, -0.441495001379958], [33.9522895809163, -0.436744988255081], [33.9562606813082, -0.436861009014392], [33.955379485646, -0.439756006467532]]], [[[34.0426788324311, -0.441617995922242], [34.0579109193315, -0.454786986694148], [34.0618209834879, -0.466004014204983], [34.0680007929779, -0.475248992840064], [34.0617904656388, -0.483705997355769], [34.0581703181331, -0.486158997364131], [34.0514488214515, -0.48744401352108], [34.0425796502369, -0.492495000572894], [34.0173301691978, -0.49810600351348], [33.9986495967674, -0.499177009522071], [33.9948692319355, -0.495505989061121], [33.9925994866689, -0.489533991119976], [33.9869308467725, -0.485076010336786], [33.9746284482024, -0.482282013259886], [33.9698791503386, -0.478166014668594], [33.9621696468858, -0.480320007289396], [33.959869384821, -0.4795329870708], [33.9616203304768, -0.476166993823649], [33.9591789242271, -0.474866003235944], [33.9557609557607, -0.476051002849935], [33.9492187498746, -0.472840011421986], [33.9448890686212, -0.473563998816022], [33.9456787106334, -0.471403986181399], [33.9551696776208, -0.467249006781304], [33.9556808469152, -0.463665991905308], [33.9537200921702, -0.46022900949028], [33.9546508785988, -0.458112001448788], [33.9502983093133, -0.45217698870175], [33.9588890074224, -0.451597989312783], [33.9601211547147, -0.446150988264086], [33.9670181272535, -0.441754013979948], [33.9700202941679, -0.442532002917132], [33.9751205437283, -0.451126009810991], [33.9788589470794, -0.451622992748461], [33.9860610955408, -0.448074013291747], [33.993858337062, -0.441381007317147], [33.9966392511954, -0.441868007649385], [34.0144500725981, -0.436924994268909], [34.0217704769388, -0.426748991155693], [34.0259399414171, -0.424603999414845], [34.0310096737433, -0.425832003288011], [34.0374183653533, -0.436044991164478], [34.0426788324311, -0.441617995922242]]], [[[34.2754516596662, -0.401969999488986], [34.2715797423912, -0.401030987644172], [34.2744903559876, -0.400332987688116], [34.2754516596662, -0.401969999488986]]], [[[34.2781715389658, -0.381237000492777], [34.2761688228689, -0.382865995608465], [34.2743492121104, -0.381680995640269], [34.2783508301769, -0.379925996760625], [34.2781715389658, -0.381237000492777]]], [[[34.2143287655156, -0.395693004366286], [34.2142906182445, -0.405660004031797], [34.2120018004263, -0.411262006264649], [34.204349517321, -0.415695012092491], [34.2029495239652, -0.419582993174731], [34.1996002197026, -0.421483993822473], [34.1877708433517, -0.421559006677778], [34.1794395440855, -0.427493990015186], [34.1756782531266, -0.432850003983613], [34.165271758304, -0.438524991595183], [34.1613998410085, -0.444068014742153], [34.1456985469489, -0.429895997800304], [34.1378898619166, -0.428847998925689], [34.136909484728, -0.432891011472217], [34.134300231592, -0.433950991107749], [34.1333389278868, -0.437920988165511], [34.1311607357573, -0.438971996391205], [34.1283798215211, -0.437976003020405], [34.1264610287079, -0.433889001655333], [34.1176605223996, -0.427177011840722], [34.1166992184456, -0.422545999545391], [34.1192703248463, -0.411130011306752], [34.1313514703541, -0.415950000813917], [34.1384315486929, -0.412773013288862], [34.1467704774138, -0.40178999330445], [34.1569900507969, -0.399167001650706], [34.1601295471043, -0.394279987164107], [34.160659789502, -0.3878209894747], [34.1580696104563, -0.384274989420933], [34.1581687924587, -0.37681299451016], [34.1667213436273, -0.378331006020431], [34.1715507505398, -0.380257010370037], [34.1740303033703, -0.384128988337088], [34.1842308041676, -0.388287991819939], [34.1941604611658, -0.39040300288116], [34.1969604491079, -0.398047000614702], [34.1994781489183, -0.400009989819131], [34.2037086481541, -0.397612005717622], [34.2089195247285, -0.390827000545428], [34.2076797480607, -0.387234986055222], [34.2105598449187, -0.376715004601617], [34.2103385922229, -0.36443001056801], [34.2191810601522, -0.36015901038489], [34.2211189268839, -0.354171991759936], [34.2236709588762, -0.356640011645463], [34.2278518671235, -0.357789009821622], [34.2276496881491, -0.359632999264451], [34.2177581787943, -0.380856007496425], [34.2143287655156, -0.395693004366286]]], [[[34.2518005369727, -0.355477988879186], [34.2492980956664, -0.356083989530268], [34.2500114441154, -0.352638006396314], [34.2546806336564, -0.351561993650388], [34.2518005369727, -0.355477988879186]]], [[[34.2636184686575, -0.346350014132461], [34.2605094907419, -0.351669013877824], [34.2555198663605, -0.3504230086018], [34.2567787165965, -0.34663200411094], [34.2636184686575, -0.346350014132461]]], [[[34.7582206719739, -0.31252101087114], [34.7583808897327, -0.31669801508201], [34.7630691524777, -0.315403998108347], [34.7676086423743, -0.314383000305777], [34.7735099793049, -0.320845991625677], [34.7772483822775, -0.320601999839968], [34.7792587277671, -0.322156995636362], [34.7803993223333, -0.325801014855357], [34.7830009457264, -0.324263006498863], [34.7873992919402, -0.332888990771244], [34.7825813293905, -0.334661990704691], [34.7857704159269, -0.346581995440046], [34.7891006467147, -0.345259994365036], [34.7910690307328, -0.345991999112342], [34.7900810241752, -0.348499000422978], [34.7909393311158, -0.350154012735152], [34.7962989806356, -0.351779014158352], [34.7963409423905, -0.353913993008774], [34.799270629772, -0.35537099866552], [34.8058509826727, -0.356851994946864], [34.8103294373075, -0.35494199412092], [34.811920165839, -0.361380994683084], [34.8153495787066, -0.367538988586328], [34.822010040142, -0.375279009500654], [34.8231887818121, -0.388823986316104], [34.8349685665297, -0.390866011737571], [34.8395805358943, -0.39437299970995], [34.8547096251044, -0.393049001816052], [34.8581581113839, -0.393871993094201], [34.8591995235789, -0.396349012801326], [34.8614196776106, -0.397379994409412], [34.864028930384, -0.397596001585913], [34.8667411800724, -0.39584100258521], [34.8800506592569, -0.398986011932382], [34.882549285679, -0.39778301152296], [34.8892898558066, -0.404336005388276], [34.8909606930819, -0.403268993253184], [34.8915901180646, -0.399742990849798], [34.8960609436001, -0.398467004451745], [34.9023208614997, -0.393781006539643], [34.9141883848943, -0.389872014812091], [34.9129295347827, -0.397105991776296], [34.9135284423775, -0.406210988992565], [34.9157791136356, -0.408109992857834], [34.9262809752293, -0.406415999172597], [34.9296684262365, -0.415033996126971], [34.9339103697409, -0.415926993119768], [34.9367218016871, -0.414869993979198], [34.9400482174569, -0.417192012124249], [34.9476394649912, -0.418792009368722], [34.9588203430649, -0.419268012259248], [34.964580535695, -0.414997011740574], [34.9682312010619, -0.416606009222934], [34.9742088316808, -0.414806008342675], [34.9797897336172, -0.416812002955495], [34.9864196774759, -0.416004985686217], [34.9888610840591, -0.41196200288656], [35.0020790099141, -0.408315003142937], [35.0098304748598, -0.393557995512931], [35.0165290828926, -0.400588989310594], [35.020030975015, -0.407977998203072], [35.0201301573808, -0.413237988913887], [35.0087089539056, -0.422464013032612], [34.984081268035, -0.435945004299202], [34.9849891660104, -0.438230991460368], [34.9612197872309, -0.448563993126587], [34.9566688537146, -0.453774988592296], [34.9549102782375, -0.452564001210013], [34.9318504333034, -0.470339000564194], [34.913478851067, -0.478635013276366], [34.9130516050926, -0.481783002938289], [34.903900146467, -0.484786987561828], [34.9031181333965, -0.482174992638721], [34.8889503477, -0.486799001910646], [34.8890991210648, -0.488941997632412], [34.8768196104796, -0.494208991844917], [34.8734207150136, -0.492906988010304], [34.8568992612835, -0.506024003234788], [34.844890594425, -0.513670027293837], [34.8381004330379, -0.516238987710852], [34.8374481199198, -0.518221974371861], [34.8363800047042, -0.516646981491657], [34.8180885311651, -0.519816994747283], [34.8184700009565, -0.523418009515079], [34.8106613157707, -0.526766002395344], [34.8081092832507, -0.524913012938803], [34.791728973295, -0.533563017878239], [34.7921409604513, -0.536637008237299], [34.7841415404687, -0.54204797741411], [34.7818489074306, -0.539662003610068], [34.7724494933551, -0.543299019671276], [34.7598190305008, -0.551342010749138], [34.7590904232552, -0.554727018199034], [34.7576103208967, -0.552761972309827], [34.7526588440351, -0.557133019010684], [34.7405891414782, -0.55939000844221], [34.7276000973846, -0.556751013019578], [34.7248611448276, -0.55805397054927], [34.7239189148249, -0.562395990012802], [34.7205581663754, -0.563807010858834], [34.7084693905658, -0.56334197550079], [34.7025794979385, -0.57107502236711], [34.7027893065484, -0.574231028654441], [34.7006187437383, -0.578173995100854], [34.6939506531515, -0.585781991773064], [34.6956901546825, -0.588460028169261], [34.6820793151083, -0.605611026354928], [34.6772689817705, -0.607928991417576], [34.6687088010492, -0.608528018135938], [34.6579513547959, -0.608295023463937], [34.6559104916652, -0.606912016991926], [34.6537895201871, -0.609516978259065], [34.6391716004, -0.634738028207663], [34.6383705139055, -0.637398004544013], [34.6397781372785, -0.638979017954337], [34.6343193051887, -0.665705025246125], [34.6205406186134, -0.658393025710317], [34.6131210324846, -0.656325995932842], [34.5904312130281, -0.654632985651808], [34.581218719295, -0.654644012660536], [34.5782089233828, -0.661484003434846], [34.5757789609572, -0.663455009692252], [34.5589103696885, -0.668734014040843], [34.5568008421623, -0.676910996394468], [34.5484886165825, -0.689158976147545], [34.546669006078, -0.691166996901663], [34.5432510376571, -0.691955983595508], [34.5411796568859, -0.694706976771434], [34.5331611633244, -0.710030973139712], [34.5330390927199, -0.738547981046071], [34.5311889646065, -0.74408400068167], [34.5243301391048, -0.751465976566904], [34.523319244073, -0.755219996094406], [34.4829406738704, -0.790274977619968], [34.481559753165, -0.802295029175752], [34.4693298338285, -0.825273990933598], [34.4647102352386, -0.837071001531768], [34.4626693723591, -0.851777970927684], [34.463150024297, -0.86771601449314], [34.439430236495, -0.847472012212406], [34.4319496151321, -0.84376698732516], [34.427528381048, -0.838150978357247], [34.4123306274858, -0.830712020621397], [34.403789520136, -0.824156999657325], [34.3919181822002, -0.820127010642739], [34.3891296386327, -0.817822992967247], [34.385238647331, -0.822346985545578], [34.3878517148165, -0.828027010274183], [34.3914909362143, -0.830556988990309], [34.3912887569553, -0.832229972125801], [34.3883514403493, -0.835080981457174], [34.3813896176497, -0.847465992037647], [34.3720703123242, -0.849992990548269], [34.3659706116052, -0.855206012842816], [34.3547210691039, -0.853002011902929], [34.3498115536549, -0.850507974769047], [34.3469085691785, -0.850807011304048], [34.3483581542548, -0.857419014179398], [34.3378715512162, -0.857151985548191], [34.3353996275051, -0.861966013846852], [34.3323783872629, -0.864336014174842], [34.3219299313395, -0.866934001400902], [34.3207893371094, -0.869368016840148], [34.3120613097195, -0.862017989402179], [34.2967910765639, -0.841571986879134], [34.2831993100554, -0.829490006164039], [34.2800292969425, -0.827283978678287], [34.2706985473092, -0.826963007798812], [34.255760192745, -0.823557973140846], [34.2516403194844, -0.819657981545666], [34.2500114439606, -0.813898980606246], [34.2352981564387, -0.796841025397369], [34.2297096252092, -0.785510003755067], [34.2168884277723, -0.774847984475694], [34.2137908932448, -0.773727000078476], [34.2022590634571, -0.756389021871654], [34.1978187557433, -0.755196988621768], [34.1961212158267, -0.755307019070076], [34.1938896178212, -0.763637006417354], [34.1874885558975, -0.769863009458919], [34.1785888671669, -0.768164992467638], [34.1735115048629, -0.775547981240602], [34.1637001037083, -0.777657985893913], [34.146179199202, -0.78438401217971], [34.1350784301819, -0.790953993738234], [34.1248512266192, -0.794811010392652], [34.1202583310897, -0.787449002496724], [34.1031608581006, -0.787481009961492], [34.0980987548552, -0.789156019846152], [34.0904998777627, -0.793381989008938], [34.0821304321186, -0.805714011166162], [34.0756301878191, -0.807959020223218], [34.0731887813577, -0.805734992162836], [34.0713806149705, -0.799772024263116], [34.070911407347, -0.795912028064797], [34.0761718746124, -0.788185000296319], [34.0791702268929, -0.786366999075553], [34.0781211854283, -0.77315700064691], [34.0756797788177, -0.770870983553066], [34.0727310176464, -0.771928012775884], [34.0707702635395, -0.774968982057692], [34.0678100581323, -0.776280999365201], [34.0652008054693, -0.775638997715759], [34.0682983398867, -0.769587993507218], [34.0722885124991, -0.765767992213887], [34.0734596248886, -0.75789797296986], [34.0711402893946, -0.742384017023116], [34.0682716362661, -0.738946974186464], [34.0656585691013, -0.731875002658081], [34.0589599610651, -0.72876399809079], [34.0561790467475, -0.7291809921991], [34.0511894221542, -0.732782006194536], [34.0431709283489, -0.734619022046682], [34.0432586663373, -0.739524007362461], [34.0412483211126, -0.742564022830797], [34.0390701292639, -0.743134022115547], [34.0375518798052, -0.741271973341088], [34.0341415399172, -0.742411017949055], [34.0290107721199, -0.740079999563629], [34.0344581600094, -0.738240004025029], [34.0370407099569, -0.735108971714719], [34.0365409849073, -0.729981005287054], [34.0402297971026, -0.730431974673244], [34.0455207822751, -0.72615200287414], [34.0493698114945, -0.72751700888947], [34.0549507137005, -0.722702980450744], [34.057571411253, -0.717764974292993], [34.0569000236933, -0.714806020454154], [34.04867935143, -0.710771978655859], [34.0502204887992, -0.701833010373213], [34.0476188661232, -0.696263015386548], [34.0508689874669, -0.688364028892766], [34.0486183167265, -0.685244023969903], [34.0509605408343, -0.682855010357811], [34.0527191162991, -0.682901025140196], [34.05387115413, -0.67493999052484], [34.0474395745586, -0.666799008970179], [34.0528297425442, -0.653914988114916], [34.0501098632817, -0.649474978372914], [34.0444602961453, -0.650641978499759], [34.0443992613612, -0.648643016910792], [34.0485992431052, -0.645349979282076], [34.050479888771, -0.645856023060513], [34.0521888733874, -0.63608497387884], [34.0674095147023, -0.634290993351509], [34.0785484311953, -0.62570297740823], [34.088008880649, -0.611697971865403], [34.0916709895808, -0.610395014213498], [34.0937614438246, -0.605754018462416], [34.0918388365711, -0.600144982953824], [34.0879898064917, -0.596826971219836], [34.0745315544818, -0.597922981413904], [34.0739402768513, -0.595815003636328], [34.0774497980607, -0.5891940001894], [34.0760116570081, -0.586480021509032], [34.0684509274621, -0.583840012666918], [34.0651397701482, -0.576095999009033], [34.0606918334776, -0.572252988952719], [34.0639114377092, -0.567799985398557], [34.0726585385331, -0.56365597311954], [34.0796394349264, -0.56975299151503], [34.083549499657, -0.571188987051289], [34.0907783504521, -0.570609986860741], [34.1054115294824, -0.559733987424752], [34.107849120367, -0.552416026847594], [34.1064682007827, -0.547809005070191], [34.1071090695246, -0.543847978198801], [34.1143112175524, -0.536817014212047], [34.1167907714685, -0.539178014319734], [34.1197319029813, -0.550728977437468], [34.1235885614383, -0.552347004589108], [34.1289405823148, -0.551360011161143], [34.1317291253374, -0.552417993454294], [34.1394081113554, -0.548582017566871], [34.1423187250372, -0.544880986087096], [34.144321441609, -0.545468986685797], [34.1475105283877, -0.543361008615654], [34.152400970355, -0.543421984053153], [34.156341552752, -0.545683026385006], [34.1595382683595, -0.540082991103644], [34.1603202817098, -0.515251994711433], [34.1581497192617, -0.504496992292562], [34.1604881281574, -0.499439001384675], [34.1609497063407, -0.489695996220955], [34.163379669048, -0.483860999881784], [34.1732902527968, -0.470301002784427], [34.1869506834279, -0.460844010098408], [34.1926994320973, -0.454766006007449], [34.2032890318822, -0.4207769933714], [34.2061386102449, -0.424387008706865], [34.2087097168159, -0.431968003499942], [34.2182998652968, -0.438279002810108], [34.2254219053305, -0.436731010872808], [34.2365684502905, -0.441911995742642], [34.2524681086205, -0.436401009552138], [34.2529907221092, -0.44451698703856], [34.2594184869813, -0.446025997923519], [34.2629013060622, -0.452048987886204], [34.2688789366629, -0.45137000094824], [34.2703590387349, -0.455511004157731], [34.2741394036691, -0.458741009483158], [34.280330657895, -0.456106007033767], [34.2824592583154, -0.45748299434674], [34.2834892273559, -0.459463000604624], [34.2800407402638, -0.460276991155232], [34.2789001466036, -0.463705003632667], [34.283550261735, -0.469538987016963], [34.2834396362384, -0.473872006067547], [34.2976913450659, -0.475064009430141], [34.3135986329124, -0.480857998356647], [34.3105201715903, -0.474254995573612], [34.3003311153427, -0.467819005557572], [34.3049507136834, -0.463645995390642], [34.3085594172338, -0.463880002625653], [34.315311431233, -0.459791988851047], [34.317020415631, -0.451388002025403], [34.3193092341998, -0.450635999371566], [34.3215293879414, -0.453613012918267], [34.3230705258005, -0.463761985581871], [34.3267593379654, -0.468165010196024], [34.3342285152181, -0.471148014610527], [34.3357505794744, -0.473010987297488], [34.3354301451036, -0.4886249906958], [34.3418083185914, -0.493146986526297], [34.3470687859187, -0.500118971602229], [34.3529014582467, -0.493514001737942], [34.3521194456529, -0.483509987777601], [34.366508483601, -0.479157001339806], [34.3675308224165, -0.476034999154943], [34.3668594355767, -0.464170009646362], [34.3624382015901, -0.459681987671771], [34.3632583617092, -0.456544012204122], [34.3678703301685, -0.453404993492671], [34.3700981136261, -0.449063987204993], [34.3764991752945, -0.456070005798174], [34.3916893006763, -0.458047985911118], [34.401031494224, -0.456772000208509], [34.4029693602712, -0.467581987417169], [34.4088096617819, -0.469994991905746], [34.4044914238342, -0.472618013842378], [34.4040718075724, -0.475937009620412], [34.4056816096003, -0.479736000529644], [34.4168281556415, -0.486526012354353], [34.4182815549457, -0.498194993204119], [34.4238395691904, -0.497153014227329], [34.4309196471564, -0.492648006171129], [34.4334793087006, -0.493081003646959], [34.4351005552834, -0.49733999363866], [34.4360809325886, -0.50118499989729], [34.434089660598, -0.510565996614679], [34.424320220237, -0.509644985527284], [34.4156608576732, -0.522058010291885], [34.4154510495269, -0.533038020703262], [34.4202499384653, -0.538254976419576], [34.4232292167982, -0.537786007495437], [34.43722915608, -0.530489981734109], [34.4576988221713, -0.52347499174317], [34.4714088432659, -0.515331984031223], [34.4840393059932, -0.510987997642402], [34.486560821311, -0.508825003996875], [34.4892196652765, -0.502313018317028], [34.4898605347394, -0.496461004262265], [34.4885215756286, -0.494433999326097], [34.4913215631515, -0.492246002432743], [34.4953498838338, -0.493075997261786], [34.4951210022943, -0.491421014145014], [34.4967803952732, -0.490705997263222], [34.5017700192491, -0.491519004300737], [34.5097999569706, -0.474269002690856], [34.4976615900979, -0.461302995572214], [34.4897499083798, -0.457078993406483], [34.4789581294039, -0.445430994406663], [34.4715805049799, -0.441020995268441], [34.466499328408, -0.432491988560971], [34.4506492612813, -0.415082007832338], [34.4478988645194, -0.403017997841618], [34.4443511956121, -0.398584991931709], [34.4436111447052, -0.39542201172729], [34.4468612671222, -0.391503989593715], [34.4472808838166, -0.385053992888977], [34.4562110896362, -0.367188007367484], [34.4594993588715, -0.354263008206138], [34.4777793883361, -0.346300005779269], [34.4901199339982, -0.34630900690649], [34.4986915589147, -0.339442015196204], [34.5182800293198, -0.333279013679969], [34.5369796747646, -0.328709006646547], [34.5505218502734, -0.328009992847082], [34.5661201477624, -0.330810994514755], [34.5712890621413, -0.336508989801025], [34.5864715573582, -0.3466799859601], [34.5956306454186, -0.348459988858955], [34.6072006223563, -0.348713010832994], [34.6107215880723, -0.343385011144085], [34.6141014098723, -0.341919005308692], [34.6267089844781, -0.340615987849872], [34.6286888119123, -0.341156005802005], [34.6325187675872, -0.350391001042175], [34.6447486877118, -0.352214009250388], [34.6584892268869, -0.356934011228453], [34.6620483394615, -0.356644988285097], [34.6638908386978, -0.354889989433075], [34.6727981561785, -0.357482999764506], [34.6768302916616, -0.356974989931195], [34.6861915588006, -0.352155000077462], [34.6959991451256, -0.354178995010005], [34.6998481746875, -0.353742986990006], [34.7048492426555, -0.350946993123794], [34.7092781065951, -0.354761988308264], [34.7306289671357, -0.356649011863722], [34.7413291932561, -0.352975011359628], [34.7559013363737, -0.352964014576499], [34.7630996703498, -0.336782008282447], [34.763130187823, -0.327603996050633], [34.7587394710526, -0.322838008741381], [34.7507514951339, -0.320596009467681], [34.7471885678729, -0.312557012604734], [34.7473487852729, -0.308162987982089], [34.7454299924869, -0.304329008317231], [34.7516098015184, -0.300310999323709], [34.7524299622871, -0.293628990558029], [34.7575492852908, -0.300999999306465], [34.7566299433373, -0.308676005154477], [34.7582206719739, -0.31252101087114]]], [[[34.3994903560935, -0.254267991244887], [34.3970108032719, -0.253908008974494], [34.4013214111923, -0.251022995196485], [34.4017791743855, -0.252530992768988], [34.3994903560935, -0.254267991244887]]], [[[34.1367187496645, -0.24409900678151], [34.1348915094622, -0.246243000392158], [34.1344490048806, -0.241639003507447], [34.1362686151219, -0.241992995808608], [34.1367187496645, -0.24409900678151]]], [[[34.1424903865964, -0.226278006942752], [34.1440010069603, -0.227889001630092], [34.1479988097435, -0.227724999554172], [34.1474494933468, -0.233108998002222], [34.1487312313635, -0.235117003691857], [34.1431007386267, -0.241015002285198], [34.1433792107537, -0.245220005740591], [34.1419181823993, -0.245383993358565], [34.1405982970632, -0.243122995248227], [34.141139983766, -0.23482699730886], [34.1335601804736, -0.231389999441659], [34.1395797731, -0.230031997591843], [34.1402587885971, -0.227228999215948], [34.1424903865964, -0.226278006942752]]], [[[34.1140289307814, -0.214855000728845], [34.1142387386113, -0.221377998995979], [34.1170005791669, -0.224905997762796], [34.114749908376, -0.225765005461102], [34.1110191342269, -0.223196998939716], [34.1095314022483, -0.220057994860915], [34.1094894406354, -0.21593299523273], [34.1140289307814, -0.214855000728845]]], [[[34.4601287838158, -0.215441004048315], [34.4576797481487, -0.217079997201956], [34.4563102723182, -0.215496004321451], [34.4568099972457, -0.213398993618589], [34.4675712579274, -0.2100050007577], [34.4601287838158, -0.215441004048315]]], [[[34.518421173039, -0.206698000877984], [34.5200386045181, -0.20788300095285], [34.5236816405419, -0.206997007583868], [34.5239410394751, -0.208343998064179], [34.5185508722993, -0.213635995966025], [34.5161590576878, -0.214614004630746], [34.5155715941595, -0.211816997059059], [34.5119209287706, -0.2104970066698], [34.5082283014411, -0.216396004245904], [34.5004692075734, -0.213556006777153], [34.4984397885346, -0.218287006036259], [34.4964790342599, -0.217318997325647], [34.4956092831303, -0.212118000349885], [34.502929687432, -0.200975001600127], [34.509170532324, -0.196326002751571], [34.5174217224807, -0.194516003818882], [34.5191917419178, -0.196198002003704], [34.5162200921552, -0.202952996325382], [34.518421173039, -0.206698000877984]]], [[[34.0568504333938, -0.192895994180268], [34.055400848418, -0.193039000564602], [34.0549697873727, -0.191231996185407], [34.0574417114117, -0.189449995967354], [34.0568504333938, -0.192895994180268]]], [[[34.5378608703482, -0.183923006587942], [34.5444297783191, -0.186717003994445], [34.5436210627033, -0.18843500334416], [34.5395889277135, -0.189955994372752], [34.5374298094948, -0.188463002717202], [34.536289215183, -0.186029002680658], [34.5378608703482, -0.183923006587942]]], [[[34.5419311520741, -0.177554995459931], [34.5372085568702, -0.177201002756337], [34.5354614251704, -0.175465003046841], [34.5363998405701, -0.1735209974197], [34.5393600456777, -0.172552004755814], [34.5441207884934, -0.174659997249441], [34.5419311520741, -0.177554995459931]]], [[[34.5511016838423, -0.182683006154941], [34.5497207642557, -0.183956995819815], [34.5482292169827, -0.18155199332737], [34.5453987115703, -0.172923997004285], [34.5487403871132, -0.171819999859916], [34.5495491024781, -0.173067003763431], [34.5491409300549, -0.176477000202428], [34.5524291988164, -0.179000005227063], [34.5511016838423, -0.182683006154941]]], [[[34.6083106991855, -0.160131007388101], [34.6149406427355, -0.159730002525364], [34.608940123785, -0.166026994763317], [34.6068801877634, -0.165728003413682], [34.6035194389719, -0.169064999321015], [34.6028289792516, -0.16241699502844], [34.6003990167273, -0.160761997604623], [34.6007881163203, -0.158963993230258], [34.6083106991855, -0.160131007388101]]], [[[34.045108794793, -0.135089994200292], [34.043380737124, -0.136049002725151], [34.0413894648103, -0.133091002945988], [34.0467910759328, -0.131053999547496], [34.0495986939957, -0.132810995049119], [34.045108794793, -0.135089994200292]]], [[[34.0102806089366, -0.128078997777673], [34.0132789612483, -0.128405005153257], [34.0161590573009, -0.126378998698566], [34.0177001950656, -0.130412996241417], [34.0238304137994, -0.133670002439227], [34.0317001341465, -0.128378004044975], [34.0367202754878, -0.126586005443822], [34.0388107294861, -0.127607003204381], [34.0369911191701, -0.130215004542825], [34.0267601010053, -0.135308995968923], [34.0240211487638, -0.141975000926457], [34.0196914668423, -0.140771999875237], [34.0166702266165, -0.143105999013996], [34.0095405575111, -0.141286999235816], [34.00308990427, -0.136683002556363], [34.0004692078828, -0.137262002154141], [33.9991111751425, -0.139939993995134], [33.9956207269556, -0.134287998315211], [33.9916610713048, -0.133346006817162], [33.9866561887919, -0.136118993785121], [33.9867858880363, -0.127811998463105], [33.9913787837895, -0.126678004990381], [33.9958686828561, -0.121123001650573], [34.0060005185283, -0.124252997846045], [34.0102806089366, -0.128078997777673]]], [[[34.0999984741821, -0.135629996806123], [34.0973281854461, -0.13674199632561], [34.0929489136276, -0.134572998173591], [34.0923995964831, -0.129841000467649], [34.0875015256742, -0.126992002052066], [34.0911407468937, -0.124214001415072], [34.0930213922766, -0.120668001512562], [34.097450255924, -0.122630000202121], [34.1001281732362, -0.127587005499911], [34.0999984741821, -0.135629996806123]]]], "type": "MultiPolygon"}, "properties": {"projectId": 2274, "projectName": "PEPFAR Kenya: Homa Bay", "projectStatus": "ARCHIVED"}, "type": "Feature"}], "type": "FeatureCollection"}'

        # act
        geojson = ProjectSearchService.get_projects_geojson(dto)

        # assert
        self.assertEquals(str(expected), str(expected))

    def test_make_polygon_from_3857_bbox(self):

        if self.skip_tests:
            return

        # arrange
        expected = (32.50198296132938, -12.59912449955007, 34.68826225820438, -11.578583176891955)

        # act
        polygon = ProjectSearchService._make_4326_polygon_from_bbox(
            [3618104.193026841, -1413969.7644834695, 3861479.691086842, -1297785.4814900015], 3857)

        # assert
        self.assertEquals(expected, polygon.bounds)

    def test_get_area_from_3857_bbox(self):

        if self.skip_tests:
            return

        # arrange

        # polygon = ProjectSearchService._make_4326_polygon_from_bbox([3618104.193026841, -1413969.7644834695, 3861479.691086842, -1297785.4814900015], 3857)
        polygon = Polygon([(34.68826225820438, -12.59912449955007), (34.68826225820438, -11.57858317689196),
                           (32.50198296132938, -11.57858317689196), (32.50198296132938, -12.59912449955007),
                           (34.68826225820438, -12.59912449955007)])

        # act
        expected = ProjectSearchService._get_area_sqm(polygon)

        # assert
        self.assertEquals(expected, 28276407740.2797)
