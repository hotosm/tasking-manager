import os
import unittest
from server.services.grid_service import GridService
from shapely.geometry import shape
from server.models.dtos.grid_dto import GridDTO
from server import create_app
import geojson
import json


class TestGridService(unittest.TestCase):

    skip_tests = False

    @classmethod
    def setUpClass(cls):
        env = os.getenv('SHIPPABLE', 'false')

        # Firewall rules mean we can't hit Postgres from Shippable so we have to skip them in the CI build
        if env == 'true':
            cls.skip_tests = True

    def setUp(self):
        if self.skip_tests:
            return

        self.app = create_app()
        self.ctx = self.app.app_context()
        self.ctx.push()

    def tearDown(self):
        if self.skip_tests:
            return

        self.ctx.pop()

    def test_trim_grid_to_aoi_noclip_clip(self):
        # arrange
        grid_json = {
            "clipToAoi": True,
            "areaOfInterest": {
                "type": "MultiPolygon",
                "coordinates": [
                    [
                        [
                            [
                                11.454777166054331,
                                24.621395460265262
                            ],
                            [
                                11.460956975624642,
                                24.621317433227347
                            ],
                            [
                                11.461901113197886,
                                24.617181930534727
                            ],
                            [
                                11.453661367104136,
                                24.617025871151228
                            ],
                            [
                                11.454777166054331,
                                24.621395460265262
                            ]
                        ]
                    ]
                ]
            },
            "grid": {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.453247068260938,
                                            24.61456036067679
                                        ],
                                        [
                                            11.453247068260938,
                                            24.617057336671365
                                        ],
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ],
                                        [
                                            11.455993650291683,
                                            24.61456036067679
                                        ],
                                        [
                                            11.453247068260938,
                                            24.61456036067679
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69706,
                            "y": 74787,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.453247068260938,
                                            24.617057336671365
                                        ],
                                        [
                                            11.453247068260938,
                                            24.619554262806403
                                        ],
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ],
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ],
                                        [
                                            11.453247068260938,
                                            24.617057336671365
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69706,
                            "y": 74788,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.453247068260938,
                                            24.619554262806403
                                        ],
                                        [
                                            11.453247068260938,
                                            24.622051139078053
                                        ],
                                        [
                                            11.455993650291683,
                                            24.622051139078053
                                        ],
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ],
                                        [
                                            11.453247068260938,
                                            24.619554262806403
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69706,
                            "y": 74789,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.455993650291683,
                                            24.61456036067679
                                        ],
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ],
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ],
                                        [
                                            11.45874023232243,
                                            24.61456036067679
                                        ],
                                        [
                                            11.455993650291683,
                                            24.61456036067679
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69707,
                            "y": 74787,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ],
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ],
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ],
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ],
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69707,
                            "y": 74788,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ],
                                        [
                                            11.455993650291683,
                                            24.622051139078053
                                        ],
                                        [
                                            11.45874023232243,
                                            24.622051139078053
                                        ],
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ],
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69707,
                            "y": 74789,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.45874023232243,
                                            24.61456036067679
                                        ],
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ],
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ],
                                        [
                                            11.461486814353208,
                                            24.61456036067679
                                        ],
                                        [
                                            11.45874023232243,
                                            24.61456036067679
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69708,
                            "y": 74787,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ],
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ],
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ],
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ],
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69708,
                            "y": 74788,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ],
                                        [
                                            11.45874023232243,
                                            24.622051139078053
                                        ],
                                        [
                                            11.461486814353208,
                                            24.622051139078053
                                        ],
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ],
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69708,
                            "y": 74789,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.461486814353208,
                                            24.61456036067679
                                        ],
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ],
                                        [
                                            11.464233396383955,
                                            24.617057336671365
                                        ],
                                        [
                                            11.464233396383955,
                                            24.61456036067679
                                        ],
                                        [
                                            11.461486814353208,
                                            24.61456036067679
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69709,
                            "y": 74787,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ],
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ],
                                        [
                                            11.464233396383955,
                                            24.619554262806403
                                        ],
                                        [
                                            11.464233396383955,
                                            24.617057336671365
                                        ],
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69709,
                            "y": 74788,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ],
                                        [
                                            11.461486814353208,
                                            24.622051139078053
                                        ],
                                        [
                                            11.464233396383955,
                                            24.622051139078053
                                        ],
                                        [
                                            11.464233396383955,
                                            24.619554262806403
                                        ],
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69709,
                            "y": 74789,
                            "zoom": 17
                        }
                    }
                ]
            }
        }
        grid_dto = GridDTO(grid_json)
        expected =  geojson.FeatureCollection([{"type": "Feature", "geometry": {"type": "MultiPolygon", "coordinates": [[[[11.455322708388653, 24.617057336671365], [11.453661367104136, 24.617025871151228], [11.453669402000191, 24.617057336671365], [11.455322708388653, 24.617057336671365]]]]}, "properties": {"x": 69706, "y": 74787, "zoom": 17, "splittable": False}}, {"type": "Feature", "geometry": {"type": "MultiPolygon", "coordinates": [[[[11.455993650291683, 24.6170700441964], [11.455322708388653, 24.617057336671365], [11.453669402000191, 24.617057336671365], [11.454307006014547, 24.619554262806403], [11.455993650291683, 24.619554262806403], [11.455993650291683, 24.6170700441964]]]]}, "properties": {"x": 69706, "y": 74788, "zoom": 17, "splittable": False}}, {"type": "Feature", "geometry": {"type": "MultiPolygon", "coordinates": [[[[11.454777166054331, 24.621395460265262], [11.455993650291683, 24.621380100785228], [11.455993650291683, 24.619554262806403], [11.454307006014547, 24.619554262806403], [11.454777166054331, 24.621395460265262]]]]}, "properties": {"x": 69706, "y": 74789, "zoom": 17, "splittable": False}}, {"type": "Feature", "geometry": {"type": "MultiPolygon", "coordinates": [[[[11.45874023232243, 24.617122063990887], [11.455993650291683, 24.6170700441964], [11.455993650291683, 24.619554262806403], [11.45874023232243, 24.619554262806403], [11.45874023232243, 24.617122063990887]]]]}, "properties": {"x": 69707, "y": 74788, "zoom": 17, "splittable": False}}, {"type": "Feature", "geometry": {"type": "MultiPolygon", "coordinates": [[[[11.455993650291683, 24.621380100785228], [11.45874023232243, 24.621345422101715], [11.45874023232243, 24.619554262806403], [11.455993650291683, 24.619554262806403], [11.455993650291683, 24.621380100785228]]]]}, "properties": {"x": 69707, "y": 74789, "zoom": 17, "splittable": False}}, {"type": "Feature", "geometry": {"type": "MultiPolygon", "coordinates": [[[[11.46135950841598, 24.619554262806403], [11.461486814353208, 24.61899663851402], [11.461486814353208, 24.61717408378538], [11.45874023232243, 24.617122063990887], [11.45874023232243, 24.619554262806403], [11.46135950841598, 24.619554262806403]]]]}, "properties": {"x": 69708, "y": 74788, "zoom": 17, "splittable": False}}, {"type": "Feature", "geometry": {"type": "MultiPolygon", "coordinates": [[[[11.45874023232243, 24.621345422101715], [11.460956975624642, 24.621317433227347], [11.46135950841598, 24.619554262806403], [11.45874023232243, 24.619554262806403], [11.45874023232243, 24.621345422101715]]]]}, "properties": {"x": 69708, "y": 74789, "zoom": 17, "splittable": False}}, {"type": "Feature", "geometry": {"type": "MultiPolygon", "coordinates": [[[[11.461486814353208, 24.61899663851402], [11.461901113197886, 24.617181930534727], [11.461486814353208, 24.61717408378538], [11.461486814353208, 24.61899663851402]]]]}, "properties": {"x": 69709, "y": 74788, "zoom": 17, "splittable": False}}])

        # act
        grid = GridService.trim_grid_to_aoi(grid_dto)
        # assert
        print(json.dumps(grid))
        print(json.dumps(expected))
        self.assertEquals(json.dumps(grid), json.dumps(expected))

    def test_trim_grid_to_aoi_noclip(self):
        # arrange

        grid_json = {
            "clipToAoi": False,
            "areaOfInterest": {
                "type": "MultiPolygon",
                "coordinates": [
                    [
                        [
                            [
                                11.454777166054331,
                                24.621395460265262
                            ],
                            [
                                11.460956975624642,
                                24.621317433227347
                            ],
                            [
                                11.461901113197886,
                                24.617181930534727
                            ],
                            [
                                11.453661367104136,
                                24.617025871151228
                            ],
                            [
                                11.454777166054331,
                                24.621395460265262
                            ]
                        ]
                    ]
                ]
            },
            "grid": {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.453247068260938,
                                            24.61456036067679
                                        ],
                                        [
                                            11.453247068260938,
                                            24.617057336671365
                                        ],
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ],
                                        [
                                            11.455993650291683,
                                            24.61456036067679
                                        ],
                                        [
                                            11.453247068260938,
                                            24.61456036067679
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69706,
                            "y": 74787,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.453247068260938,
                                            24.617057336671365
                                        ],
                                        [
                                            11.453247068260938,
                                            24.619554262806403
                                        ],
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ],
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ],
                                        [
                                            11.453247068260938,
                                            24.617057336671365
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69706,
                            "y": 74788,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.453247068260938,
                                            24.619554262806403
                                        ],
                                        [
                                            11.453247068260938,
                                            24.622051139078053
                                        ],
                                        [
                                            11.455993650291683,
                                            24.622051139078053
                                        ],
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ],
                                        [
                                            11.453247068260938,
                                            24.619554262806403
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69706,
                            "y": 74789,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.455993650291683,
                                            24.61456036067679
                                        ],
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ],
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ],
                                        [
                                            11.45874023232243,
                                            24.61456036067679
                                        ],
                                        [
                                            11.455993650291683,
                                            24.61456036067679
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69707,
                            "y": 74787,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ],
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ],
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ],
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ],
                                        [
                                            11.455993650291683,
                                            24.617057336671365
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69707,
                            "y": 74788,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ],
                                        [
                                            11.455993650291683,
                                            24.622051139078053
                                        ],
                                        [
                                            11.45874023232243,
                                            24.622051139078053
                                        ],
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ],
                                        [
                                            11.455993650291683,
                                            24.619554262806403
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69707,
                            "y": 74789,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.45874023232243,
                                            24.61456036067679
                                        ],
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ],
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ],
                                        [
                                            11.461486814353208,
                                            24.61456036067679
                                        ],
                                        [
                                            11.45874023232243,
                                            24.61456036067679
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69708,
                            "y": 74787,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ],
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ],
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ],
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ],
                                        [
                                            11.45874023232243,
                                            24.617057336671365
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69708,
                            "y": 74788,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ],
                                        [
                                            11.45874023232243,
                                            24.622051139078053
                                        ],
                                        [
                                            11.461486814353208,
                                            24.622051139078053
                                        ],
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ],
                                        [
                                            11.45874023232243,
                                            24.619554262806403
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69708,
                            "y": 74789,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.461486814353208,
                                            24.61456036067679
                                        ],
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ],
                                        [
                                            11.464233396383955,
                                            24.617057336671365
                                        ],
                                        [
                                            11.464233396383955,
                                            24.61456036067679
                                        ],
                                        [
                                            11.461486814353208,
                                            24.61456036067679
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69709,
                            "y": 74787,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ],
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ],
                                        [
                                            11.464233396383955,
                                            24.619554262806403
                                        ],
                                        [
                                            11.464233396383955,
                                            24.617057336671365
                                        ],
                                        [
                                            11.461486814353208,
                                            24.617057336671365
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69709,
                            "y": 74788,
                            "zoom": 17
                        }
                    },
                    {
                        "type": "Feature",
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [
                                    [
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ],
                                        [
                                            11.461486814353208,
                                            24.622051139078053
                                        ],
                                        [
                                            11.464233396383955,
                                            24.622051139078053
                                        ],
                                        [
                                            11.464233396383955,
                                            24.619554262806403
                                        ],
                                        [
                                            11.461486814353208,
                                            24.619554262806403
                                        ]
                                    ]
                                ]
                            ]
                        },
                        "properties": {
                            "x": 69709,
                            "y": 74789,
                            "zoom": 17
                        }
                    }
                ]
            }
        }
        grid_dto = GridDTO(grid_json)

        expected = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.453247068260938,
                                        24.61456036067679
                                    ],
                                    [
                                        11.453247068260938,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.61456036067679
                                    ],
                                    [
                                        11.453247068260938,
                                        24.61456036067679
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69706,
                        "y": 74787,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.453247068260938,
                                        24.617057336671365
                                    ],
                                    [
                                        11.453247068260938,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.453247068260938,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69706,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.453247068260938,
                                        24.619554262806403
                                    ],
                                    [
                                        11.453247068260938,
                                        24.622051139078053
                                    ],
                                    [
                                        11.455993650291683,
                                        24.622051139078053
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.453247068260938,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69706,
                        "y": 74789,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69707,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.622051139078053
                                    ],
                                    [
                                        11.45874023232243,
                                        24.622051139078053
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69707,
                        "y": 74789,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69708,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.622051139078053
                                    ],
                                    [
                                        11.461486814353208,
                                        24.622051139078053
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69708,
                        "y": 74789,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.464233396383955,
                                        24.619554262806403
                                    ],
                                    [
                                        11.464233396383955,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69709,
                        "y": 74788,
                        "zoom": 17
                    }
                }
            ]
        }

        # act
        grid = GridService.trim_grid_to_aoi(grid_dto)
        # assert
        print(json.dumps(grid))
        print(json.dumps(expected))
        self.assertEquals(grid, expected)
